<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>European Fitness Market News</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', system-ui, sans-serif; background: #f9fafb; }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const ACCESS_TOKEN = "efm2026";
    const CATEGORIES = ["All", "Gyms & Clubs", "Nutrition", "Fitness Tech", "Wellness", "Industry", "Spain", "Italy"];
    const BLUE = "#335FFF";
    const LIME = "#CCFF00";

    const SUPABASE_URL = "https://biaiirndqzjsgqzicera.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJpYWlpcm5kcXpqc2dxemljZXJhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1ODY2NTIsImV4cCI6MjA4NzE2MjY1Mn0.TBiJ4e18GzczDS4ledMQzCScNSiBX5RYtZ5qe9Nwbqs";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const categoryKeywords = {
      "Gyms & Clubs": ["gym", "club", "fitness center", "studio", "crossfit", "boutique"],
      "Nutrition": ["nutrition", "supplement", "protein", "diet", "food", "wellness food"],
      "Fitness Tech": ["app", "wearable", "technology", "digital", "ai", "software", "platform"],
      "Wellness": ["wellness", "mental health", "yoga", "pilates", "spa", "recovery"],
      "Spain": ["spain", "espa√±a", "spanish", "madrid", "barcelona", "valencia", "seville", "bilbao"],
      "Italy": ["italy", "italia", "italian", "rome", "milan", "milano", "turin", "torino", "naples"],
      "Industry": ["market", "investment", "acquisition", "revenue", "growth", "trend", "report"],
    };

    function classifyArticle(title, desc) {
      const text = (title + " " + desc).toLowerCase();
      const cats = Object.entries(categoryKeywords)
        .filter(([, kws]) => kws.some(k => text.includes(k)))
        .map(([cat]) => cat);
      return cats.length > 0 ? cats : ["Industry"];
    }

    function today() { return new Date().toISOString().split("T")[0]; }
    function formatDate(d) {
      return new Date(d).toLocaleDateString("en-GB", { day: "numeric", month: "short", year: "numeric" });
    }

    function NewsCard({ article }) {
      const [hovered, setHovered] = React.useState(false);
      return (
        <div
          onMouseEnter={() => setHovered(true)}
          onMouseLeave={() => setHovered(false)}
          style={{ background: hovered ? "#f5f7ff" : "#fff", border: `1px solid ${hovered ? BLUE : "#e5e7eb"}`, borderRadius: 14, padding: "20px 24px", display: "flex", flexDirection: "column", gap: 10, transition: "all 0.2s" }}
        >
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", gap: 12, flexWrap: "wrap" }}>
            <div style={{ display: "flex", gap: 6, flexWrap: "wrap" }}>
              {(Array.isArray(article.category) ? article.category : [article.category]).map(cat => (
                <span key={cat} style={{ background: LIME, color: "#111", fontSize: 11, fontWeight: 700, padding: "3px 10px", borderRadius: 20, whiteSpace: "nowrap", letterSpacing: "0.5px", textTransform: "uppercase" }}>{cat}</span>
              ))}
            </div>
            <span style={{ color: "#9ca3af", fontSize: 12, whiteSpace: "nowrap" }}>{article.date}</span>
          </div>
          <h3 style={{ color: BLUE, fontSize: 16, fontWeight: 700, margin: 0, lineHeight: 1.4 }}>{article.title}</h3>
          <p style={{ color: "#374151", fontSize: 14, margin: 0, lineHeight: 1.6 }}>{article.description}</p>
          <a href={article.url} target="_blank" rel="noopener noreferrer"
            style={{ color: BLUE, fontSize: 13, fontWeight: 700, textDecoration: "none", marginTop: 4, width: "fit-content" }}>
            Read full article ‚Üí
          </a>
        </div>
      );
    }

    function LoadingCard() {
      return (
        <div style={{ background: "#fff", border: "1px solid #e5e7eb", borderRadius: 14, padding: "20px 24px", display: "flex", flexDirection: "column", gap: 12 }}>
          {[100, 70, 90].map((w, i) => (
            <div key={i} style={{ height: i === 1 ? 20 : 14, width: `${w}%`, background: "linear-gradient(90deg,#f3f4f6 25%,#e5e7eb 50%,#f3f4f6 75%)", backgroundSize: "200% 100%", borderRadius: 6, animation: "shimmer 1.5s infinite" }} />
          ))}
        </div>
      );
    }

    function App() {
      const [unlocked, setUnlocked] = React.useState(false);
      const [tokenInput, setTokenInput] = React.useState("");
      const [tokenError, setTokenError] = React.useState(false);
      const [allDays, setAllDays] = React.useState({});
      const [selectedDay, setSelectedDay] = React.useState(today());
      const [loading, setLoading] = React.useState(false);
      const [activeCategory, setActiveCategory] = React.useState("All");
      const [sortBy, setSortBy] = React.useState("date");
      const [error, setError] = React.useState(null);
      const [status, setStatus] = React.useState("");

      React.useEffect(() => {
        if (window.location.hash.includes("access=" + ACCESS_TOKEN)) setUnlocked(true);
      }, []);

      React.useEffect(() => {
        if (unlocked) loadHistory();
      }, [unlocked]);

      async function loadHistory() {
        const { data, error } = await supabase.from("news").select("date, articles").order("date", { ascending: false });
        if (error) { setError("Could not load history: " + error.message); return; }
        const days = {};
        (data || []).forEach(row => { days[row.date] = JSON.parse(row.articles); });
        setAllDays(days);
        if (!days[today()]) fetchNews();
      }

      async function fetchNews() {
        setLoading(true);
        setError(null);
        setStatus("");
        const todayStr = today();
        try {
          const sixMonthsAgoStr = sixMonthsAgo.toISOString().split("T")[0];
          const prompt = `Search for the 20 most recent news articles about the European fitness market published in the last 6 months (after ${sixMonthsAgoStr}). Include news about gyms, fitness clubs, nutrition, fitness technology, wellness, investments, and market trends in Europe. Include results specifically from Spain and Italy.

IMPORTANT: Only include articles published after ${sixMonthsAgoStr}. Do not include older articles.

Output ONLY a raw JSON array of exactly 20 articles with no extra text, no apologies, no markdown, no explanation:

[{"title":"...","description":"2-3 sentence summary","url":"https://...","source":"...","date":"YYYY-MM-DD"},...]

Rules:
- Include at least 2 articles from Spain and 2 from Italy
- Every article must have a real publication date in YYYY-MM-DD format
- No articles older than ${sixMonthsAgoStr}
- Output ONLY the JSON array starting with [ and ending with ]
- Do not wrap in markdown code blocks`;

          const response = await fetch("/api/fetch-news", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ prompt }),
          });

          const data = await response.json();
          if (data.error) throw new Error(data.error);
          const text = (data.content || []).filter(b => b.type === "text").map(b => b.text).join("");
          const jsonMatch = text.match(/\[[\s\S]*\]/);
          if (!jsonMatch) throw new Error(`No JSON found. Response: ${JSON.stringify(data).slice(0, 300)}`);
          const enriched = JSON.parse(jsonMatch[0])
            .slice(0, 20)
            .map(a => ({ ...a, category: classifyArticle(a.title, a.description) }));

          // Save to Supabase
          const { error: dbError } = await supabase.from("news").upsert({ date: todayStr, articles: JSON.stringify(enriched) }, { onConflict: "date" });
          if (dbError) setStatus("‚ö† " + dbError.message);
          else setStatus("‚úì Saved");

          setAllDays(prev => ({ ...prev, [todayStr]: enriched }));
          setSelectedDay(todayStr);
        } catch (e) {
          setError("Error: " + e.message);
        }
        setLoading(false);
      }

      const articles = allDays[selectedDay] || [];
      const filtered = articles
        .filter(a => activeCategory === "All" || (Array.isArray(a.category) ? a.category.includes(activeCategory) : a.category === activeCategory))
        .sort((a, b) => sortBy === "date" ? new Date(b.date) - new Date(a.date) : 0);
      const sortedDays = Object.keys(allDays).sort((a, b) => new Date(b) - new Date(a));

      if (!unlocked) {
        return (
          <div style={{ minHeight: "100vh", background: "#f9fafb", display: "flex", alignItems: "center", justifyContent: "center", padding: 24 }}>
            <div style={{ background: "#fff", border: "1px solid #e5e7eb", borderRadius: 20, padding: "48px 40px", maxWidth: 400, width: "100%", textAlign: "center", boxShadow: "0 4px 24px rgba(0,0,0,0.06)" }}>
              <div style={{ width: 64, height: 64, borderRadius: 16, background: LIME, display: "flex", alignItems: "center", justifyContent: "center", fontSize: 30, margin: "0 auto 20px" }}>üèãÔ∏è</div>
              <h1 style={{ color: BLUE, fontSize: 22, fontWeight: 800, margin: "0 0 8px" }}>European Fitness Market News</h1>
              <p style={{ color: "#6b7280", fontSize: 14, marginBottom: 32 }}>Private feed. Enter your access code to continue.</p>
              <input type="password" placeholder="Access code" value={tokenInput}
                onChange={e => { setTokenInput(e.target.value); setTokenError(false); }}
                onKeyDown={e => { if (e.key === "Enter") { if (tokenInput === ACCESS_TOKEN) setUnlocked(true); else setTokenError(true); } }}
                style={{ width: "100%", padding: "12px 16px", borderRadius: 10, border: tokenError ? "1px solid #ef4444" : "1px solid #d1d5db", background: "#f9fafb", color: "#111", fontSize: 15, outline: "none", marginBottom: 12 }}
              />
              {tokenError && <p style={{ color: "#ef4444", fontSize: 13, marginBottom: 12 }}>Incorrect code. Try again.</p>}
              <button onClick={() => { if (tokenInput === ACCESS_TOKEN) setUnlocked(true); else setTokenError(true); }}
                style={{ width: "100%", padding: "12px", borderRadius: 10, border: "none", background: BLUE, color: "#fff", fontSize: 15, fontWeight: 700, cursor: "pointer" }}>
                Enter
              </button>
            </div>
          </div>
        );
      }

      return (
        <div style={{ minHeight: "100vh", background: "#f9fafb" }}>
          <div style={{ background: "#fff", borderBottom: "1px solid #e5e7eb", padding: "18px 32px", display: "flex", alignItems: "center", justifyContent: "space-between", flexWrap: "wrap", gap: 16 }}>
            <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
              <div style={{ width: 40, height: 40, borderRadius: 10, background: LIME, display: "flex", alignItems: "center", justifyContent: "center", fontSize: 20 }}>üèãÔ∏è</div>
              <div>
                <h1 style={{ margin: 0, fontSize: 18, fontWeight: 800, color: BLUE }}>European Fitness Market News</h1>
                {status && <p style={{ margin: "2px 0 0", color: status.includes("‚úì") ? "#16a34a" : "#d97706", fontSize: 11, fontWeight: 600 }}>{status}</p>}
              </div>
            </div>
            <button onClick={fetchNews} disabled={loading}
              style={{ padding: "10px 20px", borderRadius: 10, border: `1.5px solid ${BLUE}`, background: "#fff", color: BLUE, fontWeight: 700, fontSize: 14, cursor: loading ? "not-allowed" : "pointer", opacity: loading ? 0.5 : 1 }}>
              {loading ? "Loading..." : "‚ü≥ Refresh Today"}
            </button>
          </div>

          <div style={{ display: "flex", minHeight: "calc(100vh - 77px)" }}>
            {/* Sidebar */}
            <div style={{ width: 180, minWidth: 180, borderRight: "1px solid #e5e7eb", padding: "24px 16px", background: "#fff", display: "flex", flexDirection: "column", gap: 6 }}>
              <p style={{ color: "#9ca3af", fontSize: 11, fontWeight: 700, textTransform: "uppercase", letterSpacing: "0.8px", margin: "0 0 10px" }}>History</p>
              {sortedDays.length === 0 && <p style={{ color: "#d1d5db", fontSize: 12 }}>No saved days yet.</p>}
              {sortedDays.map(d => (
                <button key={d} onClick={() => { setSelectedDay(d); setActiveCategory("All"); }}
                  style={{ padding: "9px 12px", borderRadius: 8, border: "1px solid", borderColor: selectedDay === d ? BLUE : "#e5e7eb", background: selectedDay === d ? `${BLUE}08` : "transparent", color: selectedDay === d ? BLUE : "#6b7280", fontSize: 12, fontWeight: 700, cursor: "pointer", textAlign: "left" }}>
                  {d === today() ? "Today" : formatDate(d)}
                  <span style={{ display: "block", color: "#9ca3af", fontSize: 11, fontWeight: 400 }}>{(allDays[d] || []).length} articles</span>
                </button>
              ))}
            </div>

            {/* Main */}
            <div style={{ flex: 1, padding: "24px 32px 48px" }}>
              <div style={{ display: "flex", gap: 8, flexWrap: "wrap", alignItems: "center", marginBottom: 24 }}>
                {CATEGORIES.map(cat => (
                  <button key={cat} onClick={() => setActiveCategory(cat)}
                    style={{ padding: "7px 16px", borderRadius: 20, border: "1.5px solid", borderColor: activeCategory === cat ? BLUE : "#e5e7eb", background: activeCategory === cat ? BLUE : "#fff", color: activeCategory === cat ? "#fff" : "#6b7280", fontSize: 13, fontWeight: 700, cursor: "pointer" }}>
                    {cat}
                  </button>
                ))}
                <select value={sortBy} onChange={e => setSortBy(e.target.value)}
                  style={{ padding: "7px 14px", borderRadius: 10, border: "1px solid #e5e7eb", background: "#fff", color: "#374151", fontSize: 13, cursor: "pointer", outline: "none", marginLeft: "auto" }}>
                  <option value="relevance">Sort: Relevance</option>
                  <option value="date">Sort: Date</option>
                </select>
              </div>

              {error && <div style={{ background: "#fef2f2", border: "1px solid #fecaca", borderRadius: 12, padding: "16px 20px", color: "#dc2626", marginBottom: 24 }}>{error}</div>}

              {loading ? (
                <div style={{ display: "flex", flexDirection: "column", gap: 14 }}>
                  {Array(6).fill(0).map((_, i) => <LoadingCard key={i} />)}
                </div>
              ) : (
                <>
                  <p style={{ color: "#6b7280", fontSize: 13, marginBottom: 20 }}>
                    <span style={{ color: BLUE, fontWeight: 700 }}>{filtered.length}</span> article{filtered.length !== 1 ? "s" : ""} ‚Äî {selectedDay === today() ? <span style={{ color: BLUE, fontWeight: 700 }}>Today</span> : formatDate(selectedDay)}
                  </p>
                  <div style={{ display: "flex", flexDirection: "column", gap: 14 }}>
                    {filtered.map((a, i) => <NewsCard key={i} article={a} />)}
                  </div>
                  {filtered.length === 0 && <div style={{ textAlign: "center", padding: "60px 20px", color: "#9ca3af" }}>No articles found.</div>}
                </>
              )}
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
